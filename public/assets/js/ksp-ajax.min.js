/**
 * Optimized AJAX Handler for KSP Samosir
 * Enhanced with caching, debouncing, and efficient DOM manipulation
 */

window.KSP = {
    // Base configuration
    baseUrl: window.location.origin + '/ksp_samosir',
    csrfToken: null,
    cache: new Map(), // Response cache
    pendingRequests: new Map(), // Prevent duplicate requests
    debounceTimers: new Map(), // Debounce timers

    // Initialize with optimizations
    init: function () {
        this.setupAjaxDefaults();
        this.setupEventListeners();
        this.setupTooltips();
        this.setupModals();
        this.setupPerformanceMonitoring();
        this.setupOfflineDetection();
    },

    // Enhanced AJAX defaults with caching and optimizations
    setupAjaxDefaults: function () {
        const self = this;

        $.ajaxSetup({
            url: this.baseUrl + '/api',
            method: 'POST',
            dataType: 'json',
            cache: true,
            timeout: 30000, // 30 second timeout
            beforeSend: function (xhr, settings) {
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                if (window.KSP.csrfToken) {
                    xhr.setRequestHeader('X-CSRF-Token', window.KSP.csrfToken);
                }

                // Prevent duplicate requests
                const requestKey = self.getRequestKey(settings);
                if (self.pendingRequests.has(requestKey)) {
                    return false; // Abort duplicate request
                }
                self.pendingRequests.set(requestKey, true);
            },
            complete: function (xhr, status) {
                // Clean up pending requests
                const requestKey = self.getRequestKey(this);
                self.pendingRequests.delete(requestKey);
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    url: this.url,
                    method: this.method
                });

                // Handle specific error types
                switch (xhr.status) {
                    case 401:
                        window.KSP.showError('Sesi telah berakhir. Silakan login kembali.');
                        setTimeout(() => window.location.href = '/ksp_samosir/login', 2000);
                        break;
                    case 403:
                        window.KSP.showError('Anda tidak memiliki akses untuk tindakan ini.');
                        break;
                    case 500:
                        window.KSP.showError('Terjadi kesalahan server. Silakan coba lagi.');
                        break;
                    default:
                        window.KSP.showError('Terjadi kesalahan koneksi. Silakan coba lagi.');
                }
            }
        });
    },

    // Generate unique request key for duplicate prevention
    getRequestKey: function (settings) {
        return `${settings.method}_${settings.url}_${JSON.stringify(settings.data)}`;
    },

    // Enhanced AJAX method with caching
    ajax: function (action, data, successCallback, errorCallback, options = {}) {
        const cacheKey = options.cache ? `${action}_${JSON.stringify(data)}` : null;
        const useCache = options.cache !== false && cacheKey;

        // Return cached response if available and not expired
        if (useCache && this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.timestamp < (options.cacheTime || 300000)) { // 5 minutes default
                if (typeof successCallback === 'function') {
                    successCallback(cached.data);
                }
                return;
            } else {
                this.cache.delete(cacheKey);
            }
        }

        const requestData = {
            action: action,
            data: data || {},
            timestamp: Date.now() // Prevent caching issues
        };

        const ajaxOptions = {
            data: requestData,
            success: (response) => {
                // Cache successful responses
                if (useCache && response.success) {
                    this.cache.set(cacheKey, {
                        data: response.data,
                        timestamp: Date.now()
                    });
                }

                if (response.success) {
                    if (typeof successCallback === 'function') {
                        successCallback(response.data);
                    }
                } else {
                    if (typeof errorCallback === 'function') {
                        errorCallback(response.error);
                    } else {
                        this.showError(response.error?.message || 'Terjadi kesalahan');
                    }
                }
            },
            error: errorCallback || ((xhr, status, error) => {
                // Error already handled in ajaxSetup
            })
        };

        // Apply additional options
        if (options.debounce) {
            return this.debouncedAjax(action, ajaxOptions, options.debounce);
        }

        return $.ajax(ajaxOptions);
    },

    // Debounced AJAX for search/input fields
    debouncedAjax: function (action, ajaxOptions, delay = 300) {
        const key = `debounce_${action}`;

        if (this.debounceTimers.has(key)) {
            clearTimeout(this.debounceTimers.get(key));
        }

        return new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                $.ajax(ajaxOptions)
                    .done(resolve)
                    .fail(reject);
                this.debounceTimers.delete(key);
            }, delay);

            this.debounceTimers.set(key, timer);
        });
    },

    // Optimized DOM manipulation methods
    dom: {
        // Efficient element creation with caching
        createElement: function (tag, attributes = {}, content = '') {
            const element = document.createElement(tag);

            // Batch attribute setting
            Object.keys(attributes).forEach(attr => {
                if (attr === 'class') {
                    element.className = attributes[attr];
                } else if (attr === 'style' && typeof attributes[attr] === 'object') {
                    Object.assign(element.style, attributes[attr]);
                } else if (attr.startsWith('data-')) {
                    element.setAttribute(attr, attributes[attr]);
                } else {
                    element[attr] = attributes[attr];
                }
            });

            if (content) {
                if (typeof content === 'string') {
                    element.innerHTML = content;
                } else if (content.nodeType) {
                    element.appendChild(content);
                }
            }

            return element;
        },

        // Batch DOM updates for performance
        batchUpdate: function (updates) {
            const fragment = document.createDocumentFragment();

            updates.forEach(update => {
                const element = typeof update.selector === 'string'
                    ? document.querySelector(update.selector)
                    : update.element;

                if (element && update.action) {
                    update.action(element);
                }
            });

            return fragment;
        },

        // Efficient table row updates
        updateTableRow: function (tableId, rowId, data) {
            const table = document.getElementById(tableId);
            if (!table) return;

            let row = table.querySelector(`tr[data-id="${rowId}"]`);
            if (!row) {
                row = this.createElement('tr', { 'data-id': rowId });
                table.querySelector('tbody').appendChild(row);
            }

            // Update cells efficiently
            Object.keys(data).forEach((key, index) => {
                let cell = row.cells[index];
                if (!cell) {
                    cell = row.insertCell(index);
                }
                cell.textContent = data[key];
            });
        }
    },

    // Enhanced event handling with delegation
    events: {
        // Event delegation for better performance
        delegate: function (selector, event, handler, container = document) {
            container.addEventListener(event, function (e) {
                if (e.target.matches(selector) || e.target.closest(selector)) {
                    handler.call(e.target, e);
                }
            });
        },

        // Throttled event handling
        throttle: function (func, limit) {
            let inThrottle;
            return function () {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        },

        // Lazy loading for images and content
        lazyLoad: function (selector = 'img[data-src]') {
            const images = document.querySelectorAll(selector);
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });

            images.forEach(img => imageObserver.observe(img));
        }
    },

    // Enhanced UI utilities
    ui: {
        // Efficient loading states
        setLoading: function (element, loading = true) {
            if (typeof element === 'string') {
                element = document.querySelector(element);
            }

            if (!element) return;

            element.classList.toggle('loading', loading);
            element.style.pointerEvents = loading ? 'none' : '';
            element.setAttribute('aria-busy', loading);
        },

        // Optimized notifications with queue
        notifications: [],
        showNotification: function (message, type = 'info', duration = 5000) {
            // Remove existing notification
            const existing = document.querySelector('.ksp-notification');
            if (existing) {
                existing.remove();
            }

            const notification = KSP.dom.createElement('div', {
                class: `alert alert-${type} alert-dismissible fade show position-fixed`,
                style: {
                    top: '20px',
                    right: '20px',
                    zIndex: '1050',
                    maxWidth: '400px'
                },
                role: 'alert'
            }, `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `);

            document.body.appendChild(notification);

            // Auto remove
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, duration);
            }

            return notification;
        },

        // Efficient modal management
        modalQueue: [],
        showModal: function (content, options = {}) {
            // Reuse existing modal if available
            let modal = document.getElementById('ksp-dynamic-modal');
            if (!modal) {
                modal = KSP.dom.createElement('div', {
                    id: 'ksp-dynamic-modal',
                    class: 'modal fade',
                    tabindex: '-1'
                });
                modal.innerHTML = `
                    <div class="modal-dialog ${options.size ? 'modal-' + options.size : ''}">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${options.title || 'Modal'}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">${content}</div>
                            ${options.footer ? `<div class="modal-footer">${options.footer}</div>` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal-body').innerHTML = content;
                if (options.title) {
                    modal.querySelector('.modal-title').textContent = options.title;
                }
            }

            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            return bsModal;
        }
    },

    // API endpoints
    api: {
        // Member operations
        getMemberDetails: function (memberId, callback) {
            window.KSP.ajax('get_member_details', { member_id: memberId }, callback);
        },

        saveMember: function (memberData, callback) {
            window.KSP.ajax('save_member', memberData, callback);
        },

        deleteMember: function (memberId, callback) {
            window.KSP.ajax('delete_member', { member_id: memberId }, callback);
        },

        // Loan operations
        getLoanDetails: function (loanId, callback) {
            window.KSP.ajax('get_loan_details', { loan_id: loanId }, callback);
        },

        approveLoan: function (loanId, callback) {
            window.KSP.ajax('approve_loan', { loan_id: loanId }, callback);
        },

        rejectLoan: function (loanId, reason, callback) {
            window.KSP.ajax('reject_loan', { loan_id: loanId, reason: reason }, callback);
        },

        // Savings operations
        getSavingsHistory: function (memberId, callback) {
            window.KSP.ajax('get_savings_history', { member_id: memberId }, callback);
        },

        addSavings: function (savingsData, callback) {
            window.KSP.ajax('add_savings', savingsData, callback);
        },

        // Address operations
        getProvinces: function (callback) {
            window.KSP.ajax('get_provinces', {}, callback);
        },

        getRegencies: function (provinceId, callback) {
            window.KSP.ajax('get_regencies', { province_id: provinceId }, callback);
        },

        getDistricts: function (regencyId, callback) {
            window.KSP.ajax('get_districts', { regency_id: regencyId }, callback);
        },

        getVillages: function (districtId, callback) {
            window.KSP.ajax('get_villages', { district_id: districtId }, callback);
        },

        searchAddress: function (keyword, type, callback) {
            window.KSP.ajax('search_address', { keyword: keyword, type: type }, callback);
        },

        // Settings operations
        getSettings: function (callback) {
            window.KSP.ajax('get_settings', {}, callback);
        },

        updateSettings: function (settingsData, callback) {
            window.KSP.ajax('update_settings', settingsData, callback);
        },

        // Reports operations
        getFinancialReport: function (params, callback) {
            window.KSP.ajax('get_financial_report', params, callback);
        },

        getSHUReport: function (periodId, callback) {
            window.KSP.ajax('get_shu_report', { period_id: periodId }, callback);
        },

        // Activity operations
        getActivitySummary: function (params, callback) {
            window.KSP.ajax('get_activity_summary', params, callback);
        },

        // Meeting operations
        getMeetings: function (callback) {
            window.KSP.ajax('get_meetings', {}, callback);
        },

        saveMeetingAttendance: function (attendanceData, callback) {
            window.KSP.ajax('save_meeting_attendance', attendanceData, callback);
        }
    },

    // Enhanced setup methods
    setupPerformanceMonitoring: function () {
        // Monitor AJAX performance
        $(document).ajaxComplete(function (event, xhr, settings) {
            if (window.performance && window.performance.mark) {
                const duration = xhr.responseTime || 0;
                console.log(`AJAX ${settings.method} ${settings.url}: ${duration}ms`);

                // Log slow requests
                if (duration > 5000) { // 5 seconds
                    console.warn('Slow AJAX request detected:', settings.url, duration + 'ms');
                }
            }
        });
    },

    setupOfflineDetection: function () {
        window.addEventListener('online', function () {
            KSP.ui.showNotification('Koneksi internet tersambung kembali', 'success');
        });

        window.addEventListener('offline', function () {
            KSP.ui.showNotification('Koneksi internet terputus. Beberapa fitur mungkin tidak berfungsi.', 'warning', 0);
        });
    },

    // Enhanced utility methods
    showError: function (message) {
        this.ui.showNotification(message, 'danger');
    },

    showSuccess: function (message) {
        this.ui.showNotification(message, 'success');
    },

    // Cache management
    clearCache: function () {
        this.cache.clear();
        console.log('AJAX cache cleared');
    },

    // Performance utilities
    measurePerformance: function (name, fn) {
        const start = performance.now();
        const result = fn();
        const end = performance.now();
        console.log(`${name}: ${(end - start).toFixed(2)}ms`);
        return result;
    }
};

// Initialize on document ready
$(document).ready(function () {
    window.KSP.init();
});

// Global functions for backward compatibility
function showModal(modalId, title, content, size) {
    return window.KSP.showModal(modalId, title, content, size);
}

function hideModal(modalId) {
    window.KSP.hideModal(modalId);
}

function showToast(message, type) {
    window.KSP.showToast(message, type);
}

function formatCurrency(amount) {
    return window.KSP.formatCurrency(amount);
}
